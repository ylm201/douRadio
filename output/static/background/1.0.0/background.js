define("background/1.0.0/background",["jquery/1.10.1/jquery","underscore/1.6.0/underscore","backbone/1.1.2/backbone"],function(e){function t(e){var t=e.stack,n=t.split("\n");for(i in n)if(n[i].indexOf("chrome-extension://")>0){var o=n[1].split("/");console.log(o[o.length-1]+"_"+e.message),_gaq.push(["_trackEvent","JsError",o[o.length-1]+"_"+e.message]);break}}var n=e("background/1.0.0/radio"),o=n.init("#radio");window.port=null;var r=null,a=function(){chrome.cookies.get({url:"http://douban.com",name:"dbcl2"},function(e){e?chrome.cookies.set({url:"http://douban.fm",name:"dbcl2",value:e.value}):port&&port.postMessage({type:"login"})}),chrome.cookies.get({url:"http://douban.com",name:"ck"},function(e){e&&chrome.cookies.set({url:"http://douban.fm",name:"ck",value:e.value})})};a(),chrome.runtime.onInstalled.addListener(function(e){"update"===e.reason&&(e.previousVersion.indexOf("3.1.")<0&&window.open("options.html"),_gaq.push(["_trackEvent","update",chrome.app.getDetails().version,e.previousVersion]))}),o.on("songEnded",function(e){_gaq.push(["_trackEvent","play","session"==this.kind?"session":"normal",e&&e.kbps])}),o.on("songChanged",function(e){port&&port.postMessage({type:"songChanged",obj:e}),port||o.audio.paused||"N"==localStorage.enableNotify||(r&&chrome.notifications.clear(r,function(){}),chrome.notifications.create("",{iconUrl:o.currentSong.picture,title:o.currentSong.artist,message:o.currentSong.title,type:"basic",buttons:[{title:"\u4e0b\u4e00\u9996"}]},function(e){r=e,setTimeout(function(){chrome.notifications.clear(e,function(){})},6e3),chrome.notifications.onButtonClicked.addListener(function(t,n){t==e&&0==n&&(_gaq.push(["_trackEvent","click","skipFromNotify"]),o.skip())})})),chrome.browserAction.setTitle({title:o.currentSong.artist+":"+o.currentSong.title})}),o.on("playing",function(e){port&&port.postMessage({type:"playing",obj:{currentTime:e.currentTime,duration:e.duration}})}),chrome.extension.onConnect.addListener(function(e){"douRadio"==e.name&&(window.port=e,e.onDisconnect.addListener(function(){window.port=void 0}),a(),e.postMessage({type:"init",obj:{currentSong:o.currentSong?o.currentSong:{title:"--",artist:"--",picture:"/img/cd.jpg",like:0},playing:!o.audio.paused,volume:o.audio.volume,isReplay:o.isReplay,time:{currentTime:o.audio.currentTime,duration:o.audio.duration},heared:o.heared}}),e.onMessage.addListener(function(e){try{if("skip"==e.type)return void o.skip();if("delete"==e.type)return void o.del();if("toggleLike"==e.type)return void(0==o.currentSong.like?(o.like(),o.currentSong.like=1):(o.unlike(),o.currentSong.like=0));if("switch"==e.type)return void o.powerOn();if("togglePlay"==e.type)return void(null==o.currentSong?o.powerOn():o.audio.paused?o.audio.play():o.audio.pause());if("toggleReplay"==e.type)return void(o.isReplay=!o.isReplay);if("changeVolume"==e.type)return o.audio.volume=e.value,void(localStorage.volume=e.value);if("changeChannel"==e.type)return localStorage.channelId=e.channel.channelId,localStorage.channelName=e.channel.channelName,localStorage.channelCollected=e.channel.channelCollected,void o.powerOn();if("directPlay"==e.type)return void o.directPlay(e.sid);if("directToggleLike"==e.type)return void o.directToggleLike(e.sid);if("analysis"==e.type)return void _gaq.push(e.trackParams);return}catch(n){t(n)}}))})}),define("background/1.0.0/radio",["jquery/1.10.1/jquery","underscore/1.6.0/underscore","backbone/1.1.2/backbone"],function(e,t,n){var i=e("jquery/1.10.1/jquery"),o=e("underscore/1.6.0/underscore"),r=e("backbone/1.1.2/backbone"),a=function(){this.currentSong=null,this.songList=[],this.heared=[],this.channel=0,this.audio=null,this.isReplay=!1,this.kind=""};a.init=function(e){var t=new a;return o.extend(t,r.Events),t.audio=i(e)[0],t.audio.volume=localStorage.volume?localStorage.volume:.8,localStorage.channelId||(localStorage.setItem("channelId","0"),localStorage.setItem("channelName","\u79c1\u4eba"),localStorage.setItem("channelCollected","disabled")),t.audio.addEventListener("ended",function(){this.trigger("songEnded",this.currentSong);for(e in this.heared){var t=this.heared[e];t.sid==this.currentSong.sid&&this.heared.splice(e,1)}return this.heared.unshift(this.currentSong),this.heared.length>20&&this.heared.pop(),0==this.currentSong.playTimes&&this.reportEnd(),this.currentSong.playTimes++,this.isReplay?void this.audio.play():void(this.songList.length>1?this.changeSong():this.getPlayList(this.currentSong,"p",this.changeSong))}.bind(t)),t.audio.addEventListener("timeupdate",function(){this.trigger("playing",{currentTime:this.audio.currentTime,duration:this.audio.duration})}.bind(t)),t.audio.addEventListener("error",function(e){t.trigger("error","loadSongError_"+e.target.error.code+":"+t.currentSong.retryTimes),t.currentSong.retryTimes<3&&(t.currentSong.retryTimes++,t.currentSong.revoverTime=this.currentTime,this.load())}),t.audio.addEventListener("loadedmetadata",function(){t.currentSong.retryTimes>0&&t.currentSong.retryTimes<=3&&t.currentSong.revoverTime&&(this.currentTime=t.currentSong.revoverTime,t.trigger("error","revover:"+t.currentSong.retryTimes))}),t.getPlayList(void 0,"n",function(){t.changeSong("Y"!=localStorage.autoPlay)}),t},a.prototype.getPlayList=function(e,t,n){this.trigger("songListLoading",t),i.getJSON("http://douban.fm/j/mine/playlist",{type:t,channel:localStorage.channelId?localStorage.channelId:0,pb:localStorage.bitrate?localStorage.bitrate:64,sid:e?e.sid:"",pt:this.audio.currentTime,r:Math.random(),kbps:localStorage.bitrate?localStorage.bitrate:64,from:"mainsite"},function(e){if(e.err)return void this.trigger("songListLoadError",t);this.trigger("songListLoaded");var i=[];e.song.forEach(function(e){e.adtype&&"Y"==localStorage.filterAd?console.log("filter song"+JSON.stringify(e)):(e.picture=e.picture.replace("mpic","lpic"),e.retryTimes=0,e.playTimes=0,i.push(e))}),this.kind=e.kind,i.length>0&&(this.songList=i),n&&n.bind(this)()}.bind(this))},a.prototype.report=function(e,t){i.getJSON("http://douban.fm/j/mine/playlist",{type:e,channel:localStorage.channelId?localStorage.channelId:0,pb:localStorage.bitrate?localStorage.bitrate:64,sid:t?t.sid:this.currentSong.sid,pt:this.audio.currentTime,r:Math.random(),kbps:localStorage.bitrate?localStorage.bitrate:64,from:"mainsite"},function(e){e.err}.bind(this))},a.prototype.reportEnd=function(){i.get("http://douban.fm/j/mine/playlist",{type:"e",sid:this.currentSong.sid,channel:localStorage.channel?localStorage.channel.channelId:61,from:"mainsite"})},a.prototype.changeSong=function(e){this.currentSong=this.songList.shift(),(new Image).src=this.currentSong.picture,this.audio.src=this.currentSong.url,!e&&this.audio.play(),this.trigger("songChanged",this.currentSong)},a.prototype.skip=function(){this.audio.pause(),"session"==this.kind?(this.report("s"),this.songList.length<=1?(this.trigger("songListLoading","s"),this.getPlayList(this.currentSong,"p",this.changeSong)):this.changeSong()):this.getPlayList(this.currentSong,"s",this.changeSong)},a.prototype.like=function(e){e?e.like=1:this.currentSong.like=1,"session"==this.kind?this.report("r",e):this.getPlayList(e?e:this.currentSong,"r")},a.prototype.unlike=function(e){e?e.like=0:this.currentSong.like=0,"session"==this.kind?this.report("u",e):this.getPlayList(e?e:this.currentSong,"u")},a.prototype.del=function(){this.audio.pause(),"session"==this.kind?(this.report("b"),this.songList.length<=1?(this.trigger("songListLoading","b"),this.getPlayList(this.currentSong,"p",this.changeSong)):this.changeSong()):this.getPlayList(this.currentSong,"b",this.changeSong)},a.prototype.directPlay=function(e){for(id in this.heared){var t=this.heared[id];if(t.sid==e)return this.songList.unshift(t),void this.changeSong()}},a.prototype.directToggleLike=function(e){for(id in this.heared){var t=this.heared[id];if(t.sid==e)return void(0==t.like?this.like(t):this.unlike(t))}},a.prototype.powerOn=function(){this.audio.pause(),this.getPlayList(this.currentSong,"n",this.changeSong)},n.exports=a});