define("douRadio/background/1.0.0/background",["./radio","$","underscore","backbone","analysis"],function(a){var b=a("./radio"),c=b.init("#radio"),d=a("analysis");window.port=null;var e=null,f=function(){chrome.cookies.get({url:"http://douban.com",name:"dbcl2"},function(a){a?chrome.cookies.set({url:"http://douban.fm",name:"dbcl2",value:a.value}):port&&port.postMessage({type:"login"})}),chrome.cookies.get({url:"http://douban.com",name:"ck"},function(a){a&&chrome.cookies.set({url:"http://douban.fm",name:"ck",value:a.value})})},g=function(){localStorage.version!=chrome.app.getDetails().version&&("3.0.2"!=localStorage.version&&window.open("options.html"),d&&d.trackEvent("update",chrome.app.getDetails().version,localStorage.version?localStorage.version:"--"),localStorage.version=chrome.app.getDetails().version)};g(),f(),c.on("songEnded",function(a){d&&d.trackEvent("play","session"==this.kind?"session":"normal",a&&a.kbps)}),c.on("songChanged",function(a){port&&port.postMessage({type:"songChanged",obj:a}),port||c.audio.paused||"N"==localStorage.enableNotify||(e&&e.cancel(),e=webkitNotifications.createNotification(c.currentSong.picture,c.currentSong.artist,c.currentSong.title),e.show(),setTimeout(function(){e.cancel()},5e3)),!c.audio.paused&&chrome.browserAction.setTitle({title:c.currentSong.artist+":"+c.currentSong.title})}),c.on("songListLoading",function(a){port&&port.postMessage({type:"songListLoading",obj:a})}),c.on("songListLoaded",function(a){port&&port.postMessage({type:"songListLoaded",obj:a})}),c.on("playing",function(a){port&&port.postMessage({type:"playing",obj:{currentTime:a.currentTime,duration:a.duration}})}),chrome.extension.onConnect.addListener(function(a){"douRadio"==a.name&&(window.port=a,a.onDisconnect.addListener(function(){window.port=void 0}),f(),a.postMessage({type:"init",obj:{currentSong:c.currentSong?c.currentSong:{title:"--",artist:"--",picture:"/img/cd.jpg",like:0},playing:!c.audio.paused,volume:c.audio.volume,isReplay:c.isReplay,time:{currentTime:c.audio.currentTime,duration:c.audio.duration}}}),a.onMessage.addListener(function(a){return"skip"==a.type?(c.skip(),void 0):"delete"==a.type?(c.del(),void 0):"toggleLike"==a.type?(0==c.currentSong.like?(c.like(),c.currentSong.like=1):(c.unlike(),c.currentSong.like=0),void 0):"switch"==a.type?(c.powerOn(),void 0):"togglePlay"==a.type?(null==c.currentSong?c.powerOn():c.audio.paused?c.audio.play():c.audio.pause(),void 0):("toggleReplay"==a.type&&(c.isReplay=!c.isReplay),"changeVolume"==a.type?(c.audio.volume=a.value,void 0):("changeChannel"==a.type&&(localStorage.channelId=a.channel.channelId,localStorage.channelName=a.channel.channelName,localStorage.channelCollected=a.channel.channelCollected,c.powerOn()),void 0))}))})}),define("douRadio/background/1.0.0/radio",["$","underscore","backbone"],function(a,b,c){var d=a("$"),e=a("underscore"),f=a("backbone"),g=function(){this.currentSong=null,this.songList=[],this.channel=0,this.audio=null,this.isReplay=!1,this.kind=""};g.init=function(a){var b=new g;return e.extend(b,f.Events),b.audio=d(a)[0],b.audio.volume=localStorage.volume?localStorage.volume:.8,localStorage.channelId||(localStorage.setItem("channelId","0"),localStorage.setItem("channelName","私人"),localStorage.setItem("channelCollected","disable")),b.audio.addEventListener("ended",function(){return this.trigger("songEnded",this.currentSong),this.isReplay?(this.audio.play(),0==this.currentSong.replayTimes&&(this.reportEnd(),this.currentSong.replayTimes++),void 0):(this.reportEnd(),this.songList.length>1?this.changeSong():this.getPlayList("p",this.changeSong),void 0)}.bind(b)),b.audio.addEventListener("timeupdate",function(){this.trigger("playing",{currentTime:this.audio.currentTime,duration:this.audio.duration})}.bind(b)),b.audio.addEventListener("error",function(a){b.trigger("error","loadSongError_"+a.target.error.code+":"+b.currentSong.retryTimes),b.currentSong.retryTimes<3?(b.currentSong.retryTimes++,b.currentSong.revoverTime=this.currentTime,this.load()):console.error("exceed max retry time!")}),b.audio.addEventListener("loadedmetadata",function(){console.error("loadedmetadata!"),b.currentSong.retryTimes>0&&b.currentSong.retryTimes<=3&&b.currentSong.revoverTime&&(this.currentTime=b.currentSong.revoverTime,b.trigger("error","revover:"+b.currentSong.retryTimes))}),b.getPlayList("n",function(){b.changeSong("Y"!=localStorage.autoPlay)}),b},g.prototype.getPlayList=function(a,b){this.trigger("songListLoading",a),d.getJSON("http://douban.fm/j/mine/playlist",{type:a,channel:localStorage.channelId?localStorage.channelId:0,pb:localStorage.bitrate?localStorage.bitrate:64,sid:this.currentSong?this.currentSong.sid:"",pt:this.audio.currentTime,r:Math.random(),kbps:localStorage.bitrate?localStorage.bitrate:64,from:"mainsite"},function(c){if(c.err)return this.trigger("songListLoadError",a),void 0;this.trigger("songListLoaded");var d=[];c.song.forEach(function(a){a.adtype&&"Y"==localStorage.filterAd?console.log("filter song"+JSON.stringify(a)):(a.picture=a.picture.replace("mpic","lpic"),a.retryTimes=0,a.replayTimes=0,d.push(a))}),this.kind=c.kind,d.length>0&&(this.songList=d),b&&b.bind(this)()}.bind(this))},g.prototype.report=function(a){d.getJSON("http://douban.fm/j/mine/playlist",{type:a,channel:localStorage.channelId?localStorage.channelId:0,pb:localStorage.bitrate?localStorage.bitrate:64,sid:this.currentSong?this.currentSong.sid:"",pt:this.audio.currentTime,r:Math.random(),kbps:localStorage.bitrate?localStorage.bitrate:64,from:"mainsite"},function(a){a.err}.bind(this))},g.prototype.reportEnd=function(){d.get("http://douban.fm/j/mine/playlist",{type:"e",sid:this.currentSong.sid,channel:localStorage.channel?localStorage.channel.channelId:61,from:"mainsite"})},g.prototype.changeSong=function(a){this.currentSong=this.songList.shift(),(new Image).src=this.currentSong.picture,this.audio.src=this.currentSong.url,!a&&this.audio.play(),this.trigger("songChanged",this.currentSong)},g.prototype.skip=function(){this.audio.pause(),"session"==this.kind?(this.report("s"),this.songList.length<=1?(this.trigger("songListLoading","s"),this.getPlayList("p",this.changeSong)):this.changeSong()):this.getPlayList("s",this.changeSong)},g.prototype.like=function(){"session"==this.kind?this.report("r"):this.getPlayList("r")},g.prototype.unlike=function(){"session"==this.kind?this.report("u"):this.getPlayList("u")},g.prototype.del=function(){this.audio.pause(),"session"==this.kind?(this.report("b"),this.songList.length<=1?(this.trigger("songListLoading","b"),this.getPlayList("p",this.changeSong)):this.changeSong()):this.getPlayList("b",this.changeSong)},g.prototype.powerOn=function(){this.audio.pause(),this.getPlayList("n",this.changeSong)},c.exports=g});
